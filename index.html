<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exception Component</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #121212;
      color: #ffffff;
      font-size: 12px; /* üî• default kecil */
    }

    header {
      position: sticky;
      top: 0;
      background-color: #1f1f1f;
      padding: 12px;
      text-align: center;
      font-size: 1.3em; /* lebih besar dari body */
      font-weight: bold;
      border-bottom: 2px solid #ff9800;
      z-index: 1000;
    }

    .container {
      display: flex;
      flex-direction: row;
      padding: 12px;
      gap: 12px;
    }

    .form-section {
      width: 280px;
      background: #1e1e1e;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }
    .form-section.hidden {
      display: none;
    }

    .form-section h2 {
      margin-top: 0;
      font-size: 1em;
      border-bottom: 1px solid #444;
      padding-bottom: 6px;
    }

    .form-group {
      margin-bottom: 8px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 0.9em;
    }

    .form-group input {
      width: 100%;
      padding: 6px;
      border: 1px solid #444;
      border-radius: 6px;
      background-color: #2c2c2c;
      color: #fff;
      font-size: 0.9em;
    }

    .form-group input::placeholder {
      color: #aaa;
    }

    .form-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .form-actions button, .controls button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background-color: #ff9800;
      color: black;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85em;
    }

    .form-actions button:hover, .controls button:hover {
      background-color: #e68900;
    }

    .controls {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .controls input[type="file"] {
      font-size: 0.8em;
    }

    .table-section {
      flex: 1;
      padding: 12px;
      background-color: #1e1e1e;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1e1e1e;
      color: #fff;
      font-size: 0.8em; /* üî• kecilin font tabel */
    }

    th, td {
      border: 1px solid #fff;
      padding: 6px;
      text-align: left;
      font-weight: normal;
    }

    th {
      background: linear-gradient(135deg, #ff9800, #ffb74d);
      color: #000;
      font-weight: 600;
    }

    .action-btns button {
      margin-right: 4px;
      padding: 4px 6px;
      border: none;
      border-radius: 4px;
      background: transparent;
      font-size: 1.1em;
      cursor: pointer;
    }

    .action-btns button:hover {
      transform: scale(1.2);
    }

    .toggle-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: #444;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1001;
    }
  </style>
</head>
<body>

<header>‚ö° Exception Component</header>
<button class="toggle-btn" onclick="toggleForm()">‚ò∞</button>

<div class="container">
  <div class="form-section" id="formPanel">
    <h2>Tambah / Edit Data</h2>
    <div class="form-group"><label>Room</label><input id="room" type="text" placeholder="Masukkan Room..."></div>
    <div class="form-group"><label>Model</label><input id="model" type="text" placeholder="Masukkan Model..."></div>
    <div class="form-group"><label>Order Number</label><input id="order" type="text" placeholder="Masukkan Order Number..."></div>
    <div class="form-group"><label>Short Text</label><input id="shortText" type="text" placeholder="Deskripsi singkat..."></div>
    <div class="form-group"><label>Vendor</label><input id="vendor" type="text" placeholder="Nama Vendor..."></div>
    <div class="form-group"><label>No Quot</label><input id="noQuot" type="text" placeholder="Nomor Quotation..."></div>
    <div class="form-group"><label>Quot (PDF/PNG)</label><input id="quotFile" type="file" accept=".pdf,.png"></div>
    <div class="form-group"><label>FAR (PDF/PNG)</label><input id="farFile" type="file" accept=".pdf,.png"></div>
    <div class="form-group"><label>CCR (PDF/PNG)</label><input id="ccrFile" type="file" accept=".pdf,.png"></div>
    <div class="form-group"><label>PR</label><input id="pr" type="text" placeholder="Nomor PR..."></div>
    <div class="form-group"><label>PO</label><input id="po" type="text" placeholder="Nomor PO..."></div>
    <div class="form-group"><label>SOW</label><input id="sow" type="text" placeholder="Scope of Work..."></div>
    <div class="form-group"><label>SES</label><input id="ses" type="text" placeholder="Nomor SES..."></div>
    <div class="form-actions">
      <button onclick="addData()">‚úÖ Save</button>
      <button onclick="resetForm()">‚ôª Reset</button>
    </div>
  </div>

  <div class="table-section">
    <div class="controls">
      <button onclick="saveJSON()">üíæ Save JSON</button>
      <input type="file" accept=".json" onchange="loadJSON(event)">
    </div>
    <table id="dataTable">
      <thead>
        <tr>
          <th>Room</th><th>Model</th><th>Order</th><th>Short Text</th><th>Vendor</th><th>No Quot</th>
          <th>Quot</th><th>FAR</th><th>CCR</th><th>PR</th><th>PO</th><th>SOW</th><th>SES</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  let jobData = [];

  function toggleForm() {
    document.getElementById("formPanel").classList.toggle("hidden");
  }

  function addData() {
    const filesToBase64 = (inputId) => {
      const file = document.getElementById(inputId).files[0];
      if (!file) return null;
      return { name: file.name, type: file.type, data: null, file }; 
    };

    const data = {
      room: getVal("room"), model: getVal("model"), order: getVal("order"),
      shortText: getVal("shortText"), vendor: getVal("vendor"), noQuot: getVal("noQuot"),
      pr: getVal("pr"), po: getVal("po"), sow: getVal("sow"), ses: getVal("ses"),
      quotFile: filesToBase64("quotFile"),
      farFile: filesToBase64("farFile"),
      ccrFile: filesToBase64("ccrFile")
    };

    jobData.push(data);
    renderTable();
    resetForm();
  }

  function getVal(id) {
    return document.getElementById(id).value;
  }

  function resetForm() {
    document.querySelectorAll(".form-group input").forEach(input => input.value = "");
  }

  function renderTable() {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    jobData.forEach((item, index) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${item.room}</td><td>${item.model}</td><td>${item.order}</td><td>${item.shortText}</td>
        <td>${item.vendor}</td><td>${item.noQuot}</td><td>${item.quotFile?.name || '-'}</td>
        <td>${item.farFile?.name || '-'}</td><td>${item.ccrFile?.name || '-'}</td>
        <td>${item.pr}</td><td>${item.po}</td><td>${item.sow}</td><td>${item.ses}</td>
        <td class="action-btns">
          <button onclick="editData(${index})" title="Edit">‚úè</button>
          <button onclick="viewFiles(${index})" title="View">üëÅ</button>
          <button onclick="downloadFiles(${index})" title="Download">‚¨á</button>
          <button onclick="deleteData(${index})" title="Delete">‚ùå</button>
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  function editData(index) {
    const item = jobData[index];
    document.getElementById("room").value = item.room;
    document.getElementById("model").value = item.model;
    document.getElementById("order").value = item.order;
    document.getElementById("shortText").value = item.shortText;
    document.getElementById("vendor").value = item.vendor;
    document.getElementById("noQuot").value = item.noQuot;
    document.getElementById("pr").value = item.pr;
    document.getElementById("po").value = item.po;
    document.getElementById("sow").value = item.sow;
    document.getElementById("ses").value = item.ses;
    jobData.splice(index, 1);
    renderTable();
  }

  function viewFiles(index) {
    const item = jobData[index];
    const files = [
      { label: "Quot", file: item.quotFile },
      { label: "FAR", file: item.farFile },
      { label: "CCR", file: item.ccrFile }
    ];
    const available = files.filter(f => f.file);
    if (available.length === 0) {
      alert("Tidak ada file untuk dilihat.");
      return;
    }
    if (available.length === 1) {
      const f = available[0];
      const blob = f.file.file || f.file;
      window.open(URL.createObjectURL(blob), "_blank");
      return;
    }
    let options = "Pilih file untuk dilihat:\n";
    available.forEach((f, i) => {
      options += ${i+1}. ${f.label} (${f.file.name})\n;
    });
    const choice = prompt(options, "1");
    const idx = parseInt(choice) - 1;
    if (!isNaN(idx) && available[idx]) {
      const blob = available[idx].file.file || available[idx].file;
      window.open(URL.createObjectURL(blob), "_blank");
    }
  }

  function downloadFiles(index) {
    const files = [jobData[index].quotFile, jobData[index].farFile, jobData[index].ccrFile];
    files.forEach(f => {
      if (f?.file) {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(f.file);
        link.download = f.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    });
  }

  function deleteData(index) {
    jobData.splice(index, 1);
    renderTable();
  }

  function saveJSON() {
    const convertFile = (f) => {
      if (!f || !f.file) return null;
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = e => {
          resolve({ name: f.name, type: f.type, data: e.target.result });
        };
        reader.readAsDataURL(f.file);
      });
    };

    Promise.all(jobData.map(async item => {
      return {
        ...item,
        quotFile: await convertFile(item.quotFile),
        farFile: await convertFile(item.farFile),
        ccrFile: await convertFile(item.ccrFile)
      };
    })).then(finalData => {
      const blob = new Blob([JSON.stringify(finalData, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "jobflow_data.json";
      link.click();
    });
  }

  function loadJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      const content = JSON.parse(e.target.result);
      jobData = content.map(item => {
        const restore = (f) => {
          if (!f) return null;
          const arr = f.data.split(",");
          const mime = arr[0].match(/:(.*?);/)[1];
          const bstr = atob(arr[1]);
          let n = bstr.length;
          const u8arr = new Uint8Array(n);
          while(n--) {
            u8arr[n] = bstr.charCodeAt(n);
          }
          const blob = new Blob([u8arr], { type: mime });
          return { ...f, file: blob };
        };
        return {
          ...item,
          quotFile: restore(item.quotFile),
          farFile: restore(item.farFile),
          ccrFile: restore(item.ccrFile)
        };
      });
      renderTable();
    };
    reader.readAsText(file);
  }
</script>

</body>
</html>
