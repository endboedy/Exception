<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exception Component</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #121212;
      color: #ffffff;
      font-size: 12px;
    }
    header {
      position: sticky;
      top: 0;
      background-color: #1f1f1f;
      padding: 12px;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      border-bottom: 2px solid #ff9800;
      z-index: 1000;
    }
    .container {
      display: flex;
      flex-direction: row;
      padding: 10px;
      gap: 10px;
    }
    .form-section {
      width: 260px;
      background: #1e1e1e;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }
    .form-section.hidden { display: none; }
    .form-section h2 {
      margin-top: 0;
      font-size: 1em;
      border-bottom: 1px solid #444;
      padding-bottom: 6px;
    }
    .form-group { margin-bottom: 8px; }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 3px;
      font-size: 0.9em;
    }
    .form-group input {
      width: 100%;
      padding: 6px;
      border: 1px solid #444;
      border-radius: 6px;
      background-color: #2c2c2c;
      color: #fff;
      font-size: 0.9em;
    }
    .form-group input::placeholder { color: #aaa; }
    .form-actions { display: flex; gap: 6px; margin-top: 6px; }
    .form-actions button, .controls button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background-color: #ff9800;
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8em;
    }
    .form-actions button:hover, .controls button:hover { background-color: #e68900; }
    .controls { text-align: right; margin-bottom: 8px; }
    .controls input { font-size: 0.8em; }
    .table-section {
      flex: 1;
      padding: 10px;
      background-color: #1e1e1e;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    .filters {
      margin-bottom: 10px;
    }
    .filters label {
      margin-right: 6px;
      font-weight: bold;
    }
    .filters input, .filters select {
      margin-right: 15px;
      padding: 3px 6px;
      font-size: 0.8em;
      border-radius: 4px;
      border: 1px solid #444;
      background-color: #2c2c2c;
      color: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1e1e1e;
      color: #fff;
      font-size: 0.8em;
    }
    th, td {
      border: 1px solid #555;
      padding: 6px;
      text-align: left;
      font-weight: normal;
    }
    th {
      background-color: #ff9800;
      color: #000;
      font-weight: 600;
    }
   /* Lebarkan kolom SES & Action */
    th:nth-child(13), td:nth-child(13) {
      min-width: 40px;
    }
    th:nth-child(14), td:nth-child(14) {
      min-width:100px;
    }
	th:nth-child(12), td:nth-child(12) {
      min-width:60px;
    }
    .action-btns button {
      margin-right: 4px;
      padding: 2px 6px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .edit-btn { background-color: #4caf50; color: white; }
    .view-btn { background-color: #2196f3; color: white; }
    .download-btn { background-color: #9c27b0; color: white; }
    .delete-btn { background-color: #f44336; color: white; }
    .toggle-btn {
      position: fixed;
      top: 12px;
      left: 12px;
      background-color: #444;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1001;
    }
  </style>
</head>
<body>

<header>‚öô Exception Component</header>
<button class="toggle-btn" onclick="toggleForm()">‚ò∞</button>

<div class="container">
  <div class="form-section" id="formPanel">
    <h2>Tambah / Edit Data</h2>
    <div class="form-group"><label>Room</label><input id="room" type="text" placeholder="Masukkan Room..."></div>
    <div class="form-group"><label>Model</label><input id="model" type="text" placeholder="Masukkan Model..."></div>
    <div class="form-group"><label>Order Number</label><input id="order" type="text" placeholder="Masukkan Order Number..."></div>
    <div class="form-group"><label>Short Text</label><input id="shortText" type="text" placeholder="Deskripsi singkat..."></div>
    <div class="form-group"><label>Vendor</label><input id="vendor" type="text" placeholder="Nama Vendor..."></div>
    <div class="form-group"><label>No Quot</label><input id="noQuot" type="text" placeholder="Nomor Quotation..."></div>
    <div class="form-group"><label>Quot (PDF/PNG)</label><input id="quotFile" type="file" accept=".pdf,.png"></div>
    <div class="form-group"><label>FAR (PDF/PNG)</label><input id="farFile" type="file" accept=".pdf,.png"></div>
    <div class="form-group"><label>CCR (PDF/PNG)</label><input id="ccrFile" type="file" accept=".pdf,.png"></div>
    <div class="form-group"><label>PR</label><input id="pr" type="text" placeholder="Nomor PR..."></div>
    <div class="form-group"><label>PO</label><input id="po" type="text" placeholder="Nomor PO..."></div>
    <div class="form-group"><label>SOW</label><input id="sow" type="text" placeholder="Scope of Work..."></div>
    <div class="form-group"><label>SES</label><input id="ses" type="text" placeholder="Nomor SES..."></div>
    <div class="form-actions">
      <button onclick="addData()">üíæ Save</button>
      <button onclick="resetForm()">‚ôª Reset</button>
    </div>
  </div>

  <div class="table-section">
    <div class="controls">
      <button onclick="saveJSON()">üíæ Save JSON</button>
      <input type="file" accept=".json" onchange="loadJSON(event)">
    </div>

    <!-- üîç Filter -->
    <div class="filters">
      <label>Room:</label><input type="text" id="filter-room" placeholder="Cari Room...">
      <label>Order:</label><input type="text" id="filter-order" placeholder="Cari Order...">
      <label>PR:</label><input type="text" id="filter-pr" placeholder="Cari PR...">
      <label>PO:</label><input type="text" id="filter-po" placeholder="Cari PO...">
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th>Room</th><th>Model</th><th>Order</th><th>Short Text</th><th>Vendor</th><th>No Quot</th>
          <th>Quot</th><th>FAR</th><th>CCR</th><th>PR</th><th>PO</th><th>SOW</th><th>SES</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  let jobData = [];

  function toggleForm() {
    document.getElementById("formPanel").classList.toggle("hidden");
  }

  function addData() {
    Promise.all([
      getFileBase64("quotFile"),
      getFileBase64("farFile"),
      getFileBase64("ccrFile")
    ]).then(([quotFile, farFile, ccrFile]) => {
      const data = {
        room: getVal("room"), model: getVal("model"), order: getVal("order"),
        shortText: getVal("shortText"), vendor: getVal("vendor"), noQuot: getVal("noQuot"),
        pr: getVal("pr"), po: getVal("po"), sow: getVal("sow"), ses: getVal("ses"),
        quotFile, farFile, ccrFile
      };
      jobData.push(data);
      renderTable();
      resetForm();
    });
  }

  function getVal(id) { return document.getElementById(id).value; }

  function getFileBase64(id) {
    return new Promise(resolve => {
      const fileInput = document.getElementById(id);
      if (!fileInput.files[0]) return resolve(null);
      const reader = new FileReader();
      reader.onload = () => resolve({ name: fileInput.files[0].name, data: reader.result });
      reader.readAsDataURL(fileInput.files[0]);
    });
  }

  function resetForm() {
    document.querySelectorAll(".form-group input").forEach(input => input.value = "");
  }

  function renderTable() {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    jobData.forEach((item, index) => {
      const row = document.createElement("tr");
      row.innerHTML =
        '<td>' + (item.room || '') + '</td>' +
        '<td>' + (item.model || '') + '</td>' +
        '<td>' + (item.order || '') + '</td>' +
        '<td>' + (item.shortText || '') + '</td>' +
        '<td>' + (item.vendor || '') + '</td>' +
        '<td>' + (item.noQuot || '') + '</td>' +
        '<td>' + (item.quotFile ? item.quotFile.name : '-') + '</td>' +
        '<td>' + (item.farFile ? item.farFile.name : '-') + '</td>' +
        '<td>' + (item.ccrFile ? item.ccrFile.name : '-') + '</td>' +
        '<td>' + (item.pr || '') + '</td>' +
        '<td>' + (item.po || '') + '</td>' +
        '<td>' + (item.sow || '') + '</td>' +
        '<td>' + (item.ses || '') + '</td>' +
        '<td class="action-btns">' +
          '<button class="edit-btn" onclick="editData(' + index + ')">‚úè</button>' +
          '<button class="view-btn" onclick="viewFiles(' + index + ')">üëÅ</button>' +
          '<button class="download-btn" onclick="downloadFiles(' + index + ')">‚¨á</button>' +
          '<button class="delete-btn" onclick="deleteData(' + index + ')">‚ùå</button>' +
        '</td>';
      tbody.appendChild(row);
    });
    applyFilter();
  }

  function editData(index) {
    const item = jobData[index];
    document.getElementById("room").value = item.room || '';
    document.getElementById("model").value = item.model || '';
    document.getElementById("order").value = item.order || '';
    document.getElementById("shortText").value = item.shortText || '';
    document.getElementById("vendor").value = item.vendor || '';
    document.getElementById("noQuot").value = item.noQuot || '';
    document.getElementById("pr").value = item.pr || '';
    document.getElementById("po").value = item.po || '';
    document.getElementById("sow").value = item.sow || '';
    document.getElementById("ses").value = item.ses || '';
    jobData.splice(index, 1);
    renderTable();
  }

  function viewFiles(index) {
    const item = jobData[index];
    const files = [
      { label: "Quot", file: item.quotFile },
      { label: "FAR",  file: item.farFile  },
      { label: "CCR",  file: item.ccrFile  }
    ];
    const available = files.filter(function (f) { return !!f.file; });
    if (available.length === 0) {
      alert("Tidak ada file untuk dilihat.");
      return;
    }
    if (available.length === 1) {
      const blob = dataURLtoBlob(available[0].file.data);
      window.open(URL.createObjectURL(blob), "_blank");
      return;
    }
    var options = "Pilih file untuk dilihat:\n";
    available.forEach(function (f, i) {
      options += (i + 1) + ". " + f.label + " (" + f.file.name + ")\n";
    });
    var choice = prompt(options, "1");
    var idx = parseInt(choice, 10) - 1;
    if (!isNaN(idx) && available[idx]) {
      const blob = dataURLtoBlob(available[idx].file.data);
      window.open(URL.createObjectURL(blob), "_blank");
    }
  }

  function downloadFiles(index) {
    const item = jobData[index];
    [item.quotFile, item.farFile, item.ccrFile].forEach(function (file) {
      if (file) {
        const blob = dataURLtoBlob(file.data);
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = file.name;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    });
  }

  function deleteData(index) {
    jobData.splice(index, 1);
    renderTable();
  }

  function saveJSON() {
    const blob = new Blob([JSON.stringify(jobData, null, 2)], { type: "application/json" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "exception_component.json";
    link.click();
  }

  function loadJSON(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
      jobData = JSON.parse(e.target.result);
      renderTable();
    };
    reader.readAsText(file);
  }

  function dataURLtoBlob(dataURL) {
    const arr = dataURL.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while(n--) u8arr[n] = bstr.charCodeAt(n);
    return new Blob([u8arr], {type:mime});
  }

  // üîç Filter function
  function applyFilter() {
    const roomVal = document.getElementById("filter-room").value.toLowerCase();
    const orderVal = document.getElementById("filter-order").value.toLowerCase();
    const prVal = document.getElementById("filter-pr").value.toLowerCase();
    const poVal = document.getElementById("filter-po").value.toLowerCase();

    const rows = document.querySelectorAll("#dataTable tbody tr");
    rows.forEach(row => {
      const room = row.cells[0].textContent.toLowerCase();
      const order = row.cells[2].textContent.toLowerCase();
      const pr = row.cells[9].textContent.toLowerCase();
      const po = row.cells[10].textContent.toLowerCase();

      const match =
        (roomVal === "" || room.includes(roomVal)) &&
        (orderVal === "" || order.includes(orderVal)) &&
        (prVal === "" || pr.includes(prVal)) &&
        (poVal === "" || po.includes(poVal));

      row.style.display = match ? "" : "none";
    });
  }

  document.querySelectorAll("#filter-room, #filter-order, #filter-pr, #filter-po")
    .forEach(input => input.addEventListener("input", applyFilter));
</script>

</body>
</html>
